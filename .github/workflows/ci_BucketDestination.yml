name: DBA Dash CI with Bucket Source/Destination

on: 
    push:
    workflow_dispatch:

jobs:
  build:
    name: Build
    runs-on: windows-latest

    strategy:
      fail-fast: false
      matrix:
        language: [csharp]
        sql-version: [2022]
        sql-collation: [Latin1_General_BIN]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Setup .NET Core
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: 10.0.x
          dotnet-quality: 'ga'
      
      - name: Check SDK version
        run: dotnet --list-sdks

      - name: Build
        run: dotnet build -c CLI

      - name: Build GUI
        run: dotnet build DBADashGUI -o DBADashBuild\DBADashGUIOnly

      - name: Add msbuild to PATH
        uses: microsoft/setup-msbuild@v2
        
      - name: Build DB
        run: msbuild dbadashdb -property:Configuration=CLI

      - name: Get Version
        id: GetVersion 
        shell: powershell
        run: | 
          $path = [System.IO.Path]::Combine((Get-Location),"DBADashBuild\CLI\DBADash.dll")
          $version = [System.Reflection.Assembly]::LoadFrom($path).GetName().Version
          $version.ToString(3)
          Write-Output "BUILD_NUMBER=$($version.ToString(3))" >> $env:GITHUB_OUTPUT

      - name: Get Build Reference
        id: GetBuildReference
        shell: powershell
        run: | 
                Invoke-WebRequest -Uri 'https://dataplat.dbatools.io/assets/dbatools-buildref-index.json' -OutFile 'DBADashBuild\CLI\BuildReference.json'

      - name: Zip
        shell: powershell
        run: | 
          $zipPath = "DBADash_${{steps.GetVersion.outputs.BUILD_NUMBER}}.zip"
          Compress-Archive -Path "DBADashBuild\CLI\*" -DestinationPath $zipPath
          $guiZipPath = "DBADash_GUI_Only_${{steps.GetVersion.outputs.BUILD_NUMBER}}.zip"
          Compress-Archive -Path "DBADashBuild\DBADashGUIOnly\*" -DestinationPath $guiZipPath

      - name: Start MinIO
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"
          
          # Download MinIO server
          $minioPath = "C:\minio"
          New-Item -ItemType Directory -Path $minioPath -Force | Out-Null
          
          Invoke-WebRequest -Uri "https://dl.min.io/server/minio/release/windows-amd64/minio.exe" -OutFile "$minioPath\minio.exe"
          
          # Create data directory
          $minioData = "C:\minio-data"
          New-Item -ItemType Directory -Path $minioData -Force | Out-Null
          
          # Create a batch file to start MinIO with environment variables
          "@echo off" | Out-File -FilePath "$minioPath\start-minio.bat" -Encoding ASCII
          "set MINIO_ROOT_USER=minioadmin" | Out-File -FilePath "$minioPath\start-minio.bat" -Encoding ASCII -Append
          "set MINIO_ROOT_PASSWORD=minioadmin" | Out-File -FilePath "$minioPath\start-minio.bat" -Encoding ASCII -Append
          'C:\minio\minio.exe server C:\minio-data --console-address ":9001"' | Out-File -FilePath "$minioPath\start-minio.bat" -Encoding ASCII -Append
          
          # Start MinIO as a background process using Start-Process
          $process = Start-Process -FilePath "$minioPath\start-minio.bat" -WindowStyle Hidden -PassThru
          
          Write-Output "MinIO process started with PID: $($process.Id)"
          
          # Wait for MinIO to start and verify it's running
          Write-Output "Waiting for MinIO to start..."
          $maxAttempts = 30
          $attempt = 0
          $minioReady = $false
          
          while ($attempt -lt $maxAttempts -and -not $minioReady) {
            Start-Sleep -Seconds 2
            try {
              $response = Invoke-WebRequest -Uri "http://localhost:9000/minio/health/live" -UseBasicParsing -TimeoutSec 2 -ErrorAction Stop
              if ($response.StatusCode -eq 200) {
                $minioReady = $true
                Write-Output "MinIO health check passed: $($response.StatusCode)"
              }
            } catch {
              $attempt++
              Write-Output "Waiting for MinIO... attempt $attempt of $maxAttempts"
            }
          }
          
          if (-not $minioReady) {
            Write-Error "MinIO failed to start after $maxAttempts attempts"
            exit 1
          }
          
          # Download MinIO client
          Invoke-WebRequest -Uri "https://dl.min.io/client/mc/release/windows-amd64/mc.exe" -OutFile "$minioPath\mc.exe"
          
          # Configure mc and create test bucket
          & "$minioPath\mc.exe" alias set local http://localhost:9000 minioadmin minioadmin
          & "$minioPath\mc.exe" mb local/dbadash-test
          
          # Set public policy on bucket for easier testing (optional)
          & "$minioPath\mc.exe" anonymous set download local/dbadash-test
          
          Write-Output "MinIO is running on http://localhost:9000"
          Write-Output "Console available at http://localhost:9001"
          Write-Output "Test bucket 'dbadash-test' created"
          Write-Output "Credentials: minioadmin / minioadmin"

      - name: Configure AWS Credentials for MinIO
        shell: powershell
        run: |
          $awsDir = "$env:USERPROFILE\.aws"
          New-Item -ItemType Directory -Path $awsDir -Force | Out-Null
          
          "[default]" | Out-File -FilePath "$awsDir\credentials" -Encoding ASCII
          "aws_access_key_id = minioadmin" | Out-File -FilePath "$awsDir\credentials" -Encoding ASCII -Append
          "aws_secret_access_key = minioadmin" | Out-File -FilePath "$awsDir\credentials" -Encoding ASCII -Append
                    
          Write-Output "AWS credentials configured at $awsDir"
          Write-Output "Endpoint URL for MinIO: http://localhost:9000"

      - name: Test MinIO Bucket Access
        shell: powershell
        run: |
          $ErrorActionPreference = "Continue"
          
          # Test 1: Upload a test file
          "Test content from GitHub Actions" | Out-File -FilePath "C:\test-file.txt" -Encoding ASCII
          & "C:\minio\mc.exe" cp "C:\test-file.txt" local/dbadash-test/test-file.txt
          Write-Output "Test file uploaded successfully"
          
          # Test 2: List bucket contents
          Write-Output "Bucket contents:"
          & "C:\minio\mc.exe" ls local/dbadash-test/
          
          # Test 3: Download the file
          & "C:\minio\mc.exe" cp local/dbadash-test/test-file.txt "C:\test-downloaded.txt"
          $content = Get-Content "C:\test-downloaded.txt"
          Write-Output "Downloaded file content: $content"
          
          # Test 4: Test with AWS SDK style access using credentials
          Write-Output "`nTesting AWS SDK compatibility..."
          Write-Output "Bucket endpoint: http://localhost:9000/dbadash-test"
          Write-Output "Access Key: minioadmin"
          Write-Output "Secret Key: minioadmin"
          
          Write-Output "All MinIO tests passed"

      - name: Install SQL
        uses: potatoqualitee/mssqlsuite@v1.12
        with:
          install: sqlengine
          version: ${{ matrix.sql-version }}
          collation: ${{ matrix.sql-collation }}

      - name: Check SQL Install
        run: | 
          sqlcmd -S localhost -U sa -P dbatools.I0 -d tempdb -Q "SELECT @@version as Version;"
          sqlcmd -S localhost -U sa -P dbatools.I0 -d tempdb -Q "SELECT SERVERPROPERTY('Collation') AS Collation;"

      - name: Create Identity Test DB
        run: | 
          sqlcmd -S localhost -U sa -P dbatools.I0 -d tempdb -Q "CREATE DATABASE TestIdentity"
          sqlcmd -S localhost -U sa -P dbatools.I0 -d TestIdentity -Q "CREATE TABLE dbo.IdentityTest(ID TINYINT IDENTITY(1,1));DECLARE @i INT=1; WHILE @i <250 BEGIN INSERT INTO dbo.IdentityTest  DEFAULT VALUES; SET @i+=1; END"

      - name: Install Service to Read from Bucket
        shell: powershell
        run: | 
          $ErrorActionPreference = "Stop" 
          $zipPath = "DBADash_${{steps.GetVersion.outputs.BUILD_NUMBER}}.zip"
         
          $ServiceName = "DBADashReadFromBucket"
          $InstallPath = "C:\$ServiceName"

          "Extract to $InstallPath"
          Expand-Archive -Path $zipPath -DestinationPath $InstallPath -Force -ErrorAction Stop

          Set-Location $InstallPath
          ./dbadashconfig -a SetServiceName --ServiceName $ServiceName
          ./dbadashconfig -c "http://localhost:9000/dbadash-test" -a Add
          ./dbadashconfig -c "Data Source=localhost;UID=sa;pwd=dbatools.I0;Initial Catalog=DBADashDB_FromBucket;Encrypt=True;TrustServerCertificate=True;" -a SetDestination
          ./dbadashconfig -a SetAWS --AWSAccessKey minioadmin --AWSSecretKey minioadmin
          "Install Service"
          ./DBADashService install --localsystem

          "Start Service"
          net start $ServiceName

          "Wait 60 sec"
          Start-Sleep -s 60

          "Get Logs"
          Get-ChildItem -Path "$InstallPath\Logs" | Get-Content

          exit 0
  
      - name: Install Service to Write to Bucket
        shell: powershell
        run: | 
          $ErrorActionPreference = "Stop" 
          $zipPath = "DBADash_${{steps.GetVersion.outputs.BUILD_NUMBER}}.zip"        
          
          $ServiceName = "DBADashWriteToBucket"
          $InstallPath = "C:\$ServiceName"
         
          "Extract to $InstallPath"

          Expand-Archive -Path $zipPath -DestinationPath $InstallPath -Force -ErrorAction Stop

          Set-Location $InstallPath
          "Configure"
          ./dbadashconfig -a SetServiceName --ServiceName $ServiceName
          ./dbadashconfig -c "Data Source=localhost;UID=sa;pwd=dbatools.I0;Initial Catalog=DBADashDB_Direct;Encrypt=True;TrustServerCertificate=True;" -a AddDestination
          ./dbadashconfig -c "http://localhost:9000/dbadash-test" -a AddDestination
          ./dbadashconfig -c "Data Source=localhost;UID=sa;pwd=dbatools.I0;Encrypt=True;TrustServerCertificate=True;" -a Add --PlanCollectionEnabled --SlowQueryThresholdMs 1000 --SchemaSnapshotDBs "*"
          ./dbadashconfig -a SetAWS --AWSAccessKey minioadmin --AWSSecretKey minioadmin
          "Install Service"
          ./DBADashService install --localsystem

          "Start Service"
          net start $ServiceName

          "Wait 60 sec"
          Start-Sleep -s 60

          "Get Logs"
          Get-ChildItem -Path "$InstallPath\Logs" | Get-Content

          exit 0

      - name: Wait 5min
        shell: powershell
        run: | 
          "Wait 5min"
          Start-Sleep -s 300

      - name: Stop services
        run: |
          net stop DBADashReadFromBucket
          net stop DBADashWriteToBucket
      - name: Output Log (DBADashWriteToBucket)
        shell: powershell
        run: | 
          ./Scripts/Get-LogContent -LogPath  "C:\DBADashWriteToBucket\Logs"

      - name: Output Log (DBADashReadFromBucket)
        shell: powershell
        run: | 
          ./Scripts/Get-LogContent -LogPath  "C:\DBADashReadFromBucket\Logs"

      - name: Output CollectionErrorLog FromBucket
        shell: powershell
        run: | 
          Invoke-Sqlcmd -ServerInstance $params.ServerInstance -Database "DBADashDB_FromBucket" -Query "SELECT * FROM dbo.CollectionErrorLog" -TrustServerCertificate | Format-Table

      - name: Output CollectionErrorLog Direct
        shell: powershell
        run: | 
            Invoke-Sqlcmd -ServerInstance $params.ServerInstance -Database "DBADashDB_Direct" -Query "SELECT * FROM dbo.CollectionErrorLog" -TrustServerCertificate | Format-Table

      - name: Output Table Counts FromBucket
        shell: powershell
        run: | 
          ./Scripts/Get-TableCounts -ServerInstance "LOCALHOST" -Database "DBADashDB_FromBucket" 

      - name: Output Table Counts Direct
        shell: powershell
        run: | 
            ./Scripts/Get-TableCounts -ServerInstance "LOCALHOST" -Database "DBADashDB_Direct" 

      - name: Run Pester Tests FromBucket
        shell: powershell
        run: |     
          Install-Module Pester -Force -SkipPublisherCheck
          Import-Module Pester -PassThru
          $container = New-PesterContainer -Path 'Scripts\CI_Workflow.Tests.ps1' -Data @{ Database = "DBADashDB_FromBucket" }
          Invoke-Pester -Container $container -Output Detailed

      - name: Run Pester Tests Direct
        shell: powershell
        run: |     
            $container = New-PesterContainer -Path 'Scripts\CI_Workflow.Tests.ps1' -Data @{ Database = "DBADashDB_Direct" }
            Invoke-Pester -Container $container -Output Detailed
      
      - name: Output Log and Check for Errors (DBADashWriteToBucket)
        shell: powershell
        run: | 
          ./Scripts/Get-LogContent -LogPath  "C:\DBADashWriteToBucket\Logs" -ThrowError

      - name: Output Log and Check for Errors (DBADashReadFromBucket)
        shell: powershell
        run: | 
          ./Scripts/Get-LogContent -LogPath  "C:\DBADashReadFromBucket\Logs" -ThrowError
